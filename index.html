<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tamu Express (Simple)</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

<header class="bg-green-600 text-white p-4 flex justify-between items-center">
  <h1 class="text-lg font-bold cursor-pointer">Tamu Express</h1>
  <nav class="space-x-2">
    <button class="tab px-3 py-1 rounded" data-tab="restaurants">Restaurants</button>
    <button class="tab px-3 py-1 rounded" data-tab="orders">Orders</button>
    <button class="tab px-3 py-1 rounded" data-tab="hotel">Hotel Portal</button>
    <button class="tab px-3 py-1 rounded" data-tab="admin">Admin</button>
  </nav>
</header>

<main id="app" class="p-4 flex-1"></main>

<footer id="footer" class="bg-gray-800 text-white p-3 text-center cursor-pointer">
  @ Tamu Express | Umma-Kenya
</footer>

<script type="module">
/* =========================
   Simplified Tamu Express
   Single file, same colors/layout
   ========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, doc,
  onSnapshot, getDocs, updateDoc, deleteDoc, query, where
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ---------- Firebase config (unchanged) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyApi2RjwEXEW2mTwCMiYERKUNAYL8Toddk",
  authDomain: "tamuexpress-26e4a.firebaseapp.com",
  projectId: "tamuexpress-26e4a",
  storageBucket: "tamuexpress-26e4a.appspot.com",
  messagingSenderId: "202068792631",
  appId: "1:202068792631:web:8a9b97028ebd7a45af76b2"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- State & constants ---------- */
let hotels = [], restaurants = [], orders = [];
let cart = [], currentTab = "restaurants", currentHotelId = null, currentAdmin = null, currentCustomer = null;

const SERVICE_FEE = 40;
const SERVICE_FEE_TILL = "0115613332";
const ADMIN_CRED = { user: "admin", pass: "TamuAdmin@2025" };
const appDiv = document.getElementById("app");

/* ---------- UI helpers ---------- */
const adminTab = document.querySelector(".tab[data-tab='admin']");
adminTab.style.display = "none"; // hidden until footer click

document.querySelectorAll(".tab").forEach(b => b.addEventListener("click", () => switchTab(b.dataset.tab)));
let footerClicks = 0;
document.getElementById("footer").addEventListener("click", () => {
  footerClicks++;
  if (footerClicks >= 4) { adminTab.style.display = "inline-block"; switchTab("admin"); footerClicks = 0; }
});

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".tab").forEach(b => {
    if (b.dataset.tab === tab) { b.classList.add("bg-white","text-green-700","font-semibold"); b.classList.remove("text-white"); }
    else { b.classList.remove("bg-white","text-green-700","font-semibold"); b.classList.add("text-white"); }
  });
  render();
}

function getHotelById(id) {
  return hotels.find(h => h.id === id) || { name: "Unknown", till: "N/A", approved: false, blocked: false };
}

/* ---------- Render functions (simple, compact) ---------- */
function render() {
  if (currentTab === "restaurants") renderRestaurants();
  else if (currentTab === "orders") renderOrders();
  else if (currentTab === "hotel") renderHotelPortal();
  else if (currentTab === "admin") renderAdmin();
}

/* Restaurants (customer view) */
function renderRestaurants() {
  const visible = restaurants.filter(r => r.approved && !r.blocked);
  appDiv.innerHTML = `
    <h2 class="text-xl font-semibold mb-3">All Restaurants</h2>
    ${visible.map(r => `
      <div class="bg-white p-4 rounded shadow mb-3">
        <h3 class="font-bold">${r.hotelName}</h3>
        <p class="text-sm text-gray-500">Till: ${r.till || "N/A"}</p>
        <div class="mt-2">
          ${r.menu?.length ? r.menu.map(item => `
            <div class="flex justify-between border-b py-2">
              <span>${item.name} - KSh ${item.price}</span>
              <button data-hotel="${r.hotelId}" data-name="${item.name}" data-price="${item.price}" class="addToCart bg-green-500 text-white px-2 py-1 rounded text-sm">Add</button>
            </div>`).join("") : `<p>No items yet</p>`}
        </div>
      </div>`).join("")}

    <div class="bg-white p-4 rounded shadow mt-6">
      <h3 class="font-semibold">Cart</h3>
      ${cart.length === 0 ? "<p>Empty cart</p>" : `
        <ul class="mb-2">${cart.map((c,i) => `<li>${c.name} - KSh ${c.price} <button data-i="${i}" class="remove text-red-500">x</button></li>`).join("")}</ul>
        <p>Items Total: KSh ${cart.reduce((s,i)=>s+i.price,0)}</p>
        <p>Service Fee: KSh ${SERVICE_FEE}</p>
        ${cart.length > 0 ? `<p class="mt-1 text-sm">Pay food amount to: <strong>${getHotelById(cart[0].hotelId).till || "N/A"}</strong> (${getHotelById(cart[0].hotelId).name})</p>
        <p class="text-sm">Service Fee Till: <strong>${SERVICE_FEE_TILL}</strong></p>` : ""}
        <p class="font-semibold mt-2">Total to Pay: KSh ${cart.reduce((s,i)=>s+i.price,0) + SERVICE_FEE}</p>

        <div class="mt-3">
          <h4 class="font-semibold mb-1">M-PESA details (required)</h4>
          <input id="mpesaName" class="border p-1 w-full mt-1" placeholder="M-PESA name (as on payment)">
          <input id="mpesaNumber" class="border p-1 w-full mt-2" placeholder="M-PESA number (07XXXXXXXX)">
        </div>

        <input id="custName" class="border p-1 w-full mt-3" placeholder="Your name">
        <input id="custPhone" class="border p-1 w-full mt-2" placeholder="Your phone">
        <div class="mt-2 flex gap-2">
          <button id="placeOrder" class="bg-blue-600 text-white px-3 py-1 rounded">Place Order</button>
          <button id="resetCart" class="bg-gray-600 text-white px-3 py-1 rounded">Reset</button>
        </div>`}
    </div>
  `;
}

/* Orders (customer / hotel / admin) */
function renderOrders() {
  let visibleOrders = [];
  if (currentHotelId) visibleOrders = orders.filter(o => o.hotelId === currentHotelId);
  else if (currentAdmin) visibleOrders = orders;
  else if (currentCustomer) visibleOrders = orders.filter(o => o.customerName === currentCustomer.name && o.customerPhone === currentCustomer.phone);
  else visibleOrders = [];

  appDiv.innerHTML = `
    <h2 class="text-xl font-semibold mb-3">Orders</h2>
    ${visibleOrders.length === 0 ? "<p>No orders yet</p>" : visibleOrders.map(o => {
      const hotel = getHotelById(o.hotelId);
      const itemsTotal = o.items.reduce((s,i)=>s+i.price,0);
      const total = o.total ?? (itemsTotal + (o.serviceFee ?? SERVICE_FEE));
      const canDelete = currentAdmin || (currentHotelId && currentHotelId === o.hotelId);
      const canMarkPaid = (currentHotelId && currentHotelId === o.hotelId) || currentAdmin;
      return `
        <div class="bg-white p-4 rounded shadow mb-3">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold">${o.customerName}</h3>
            <div class="${o.status === 'Paid' ? 'text-green-700 font-semibold' : 'text-yellow-600 font-semibold'}">${o.status || 'Pending'}</div>
          </div>

          <p class="text-sm text-gray-600">Phone: ${o.customerPhone}</p>
          <p class="text-sm text-gray-600">Hotel: ${hotel.name} | Hotel Till: ${hotel.till || 'N/A'}</p>

          <ul class="text-sm mt-2">${o.items.map(i=>`<li>${i.name} - KSh ${i.price}</li>`).join("")}</ul>
          <p class="text-sm mt-1">Items Total: KSh ${itemsTotal}</p>
          <p class="text-sm mt-1">Service Fee: KSh ${o.serviceFee ?? SERVICE_FEE}</p>
          <p class="text-sm mt-1">Service Fee Till: <strong>${SERVICE_FEE_TILL}</strong></p>
          <p class="font-semibold mt-1">Total to Pay: KSh ${total}</p>

          <div class="mt-2 text-sm">
            <p><strong>M-PESA Name:</strong> ${o.mpesaName || '—'}</p>
            <p><strong>M-PESA Number:</strong> ${o.mpesaNumber || '—'}</p>
          </div>

          <div class="mt-3 flex gap-2">
            ${canMarkPaid && o.status !== 'Paid' ? `<button data-id="${o.id}" class="markPaid bg-green-600 text-white px-3 py-1 rounded">Mark as Paid</button>` : ''}
            ${canDelete ? `<button data-id="${o.id}" class="deleteOrder bg-red-600 text-white px-3 py-1 rounded">Delete</button>` : ''}
          </div>
        </div>
      `;
    }).join("")}
  `;
}

/* Hotel Portal (login/register and menu) */
function renderHotelPortal() {
  if (!currentHotelId) {
    appDiv.innerHTML = `
      <div class="grid md:grid-cols-2 gap-4">
        <form id="hotelLogin" class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-2">Hotel Login</h3>
          <input name="name" placeholder="Hotel name" class="border p-2 w-full mb-2">
          <input name="pass" placeholder="Password" type="password" class="border p-2 w-full mb-2">
          <button class="bg-green-600 text-white px-3 py-1 rounded" type="submit">Login</button>
        </form>

        <form id="hotelRegister" class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-2">Register</h3>
          <input name="name" placeholder="Hotel name" class="border p-2 w-full mb-2">
          <input name="pass" placeholder="Password" type="password" class="border p-2 w-full mb-2">
          <input name="till" placeholder="Till number (e.g. 123456)" class="border p-2 w-full mb-2">
          <button class="bg-blue-600 text-white px-3 py-1 rounded" type="submit">Register</button>
        </form>
      </div>`;
    return;
  }

  const hotel = hotels.find(h => h.id === currentHotelId);
  if (!hotel) return;
  if (hotel.blocked) {
    appDiv.innerHTML = `<div class="bg-white p-4 rounded shadow"><p class="text-red-600 font-bold">Blocked by admin</p><button id="logoutHotel" class="mt-3 bg-red-500 text-white px-3 py-1 rounded">Logout</button></div>`;
    return;
  }
  if (!hotel.subscriptionExpiry || hotel.subscriptionExpiry < Date.now()) {
    appDiv.innerHTML = `<div class="bg-white p-4 rounded shadow"><p class="text-red-600 font-bold">Subscription expired. Pay KSh ${100}</p><button id="logoutHotel" class="mt-3 bg-red-500 text-white px-3 py-1 rounded">Logout</button></div>`;
    return;
  }

  const rest = restaurants.find(r => r.hotelId === currentHotelId) || { menu: [] };
  appDiv.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-bold">${hotel.name}</h2>
      <button id="logoutHotel" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
    </div>

    <div class="bg-white p-4 rounded shadow">
      <form id="addMenu" class="flex gap-2">
        <input name="name" placeholder="Item name" class="border p-2 flex-1" />
        <input name="price" type="number" placeholder="Price" class="border p-2 w-24" />
        <button class="bg-green-600 text-white px-3 py-1 rounded" type="submit">Add</button>
      </form>

      <ul class="mt-3">
        ${rest.menu.map((m,i)=>`<li>${m.name} - KSh ${m.price} <button data-i="${i}" class="removeMenu text-red-500 ml-2">x</button></li>`).join("")}
      </ul>
    </div>
  `;
}

/* Admin panel */
function renderAdmin() {
  if (!currentAdmin) {
    appDiv.innerHTML = `
      <form id="adminLogin" class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Admin Login</h3>
        <input name="user" placeholder="Username" class="border p-2 w-full mb-2">
        <input name="pass" placeholder="Password" type="password" class="border p-2 w-full mb-2">
        <button class="bg-purple-600 text-white px-3 py-1 rounded" type="submit">Login</button>
      </form>`;
    return;
  }

  appDiv.innerHTML = `
    <h2 class="text-xl font-semibold mb-3">Admin Panel</h2>
    <button id="clearAll" class="bg-red-700 text-white px-3 py-1 rounded mb-4">Clear All Data</button>

    <h3 class="font-semibold mb-2">Registered Hotels</h3>
    ${hotels.map(h => `<div class="bg-white p-3 rounded shadow mb-2 flex justify-between items-center">
      <div>
        <p class="font-semibold">${h.name}</p>
        <p>Till: ${h.till}</p>
        <p>Blocked: ${h.blocked ? "Yes" : "No"}</p>
        <p>Approved: ${h.approved ? "Yes" : "No"}</p>
      </div>
      <div class="flex gap-2">
        <button data-id="${h.id}" class="toggleBlock bg-red-500 text-white px-2 py-1 rounded">${h.blocked ? "Unblock" : "Block"}</button>
        ${!h.approved ? `<button data-id="${h.id}" class="approveHotel bg-green-500 text-white px-2 py-1 rounded">Approve</button>` : ''}
      </div>
    </div>`).join("")}

    <h3 class="font-semibold mt-4 mb-2">Orders</h3>
    <div><button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="switchTab('orders')">Go to Orders</button></div>
  `;
}

/* ---------- Firestore listeners (lightweight) ---------- */
/* Watch hotels, restaurants, orders once and keep arrays updated. */
onSnapshot(collection(db, "hotels"), snap => {
  hotels = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

onSnapshot(collection(db, "restaurants"), snap => {
  restaurants = snap.docs.map(d => {
    const data = d.data();
    const hotel = getHotelById(data.hotelId);
    return { id: d.id, ...data, hotelName: hotel.name, till: hotel.till, approved: hotel.approved, blocked: hotel.blocked };
  });
  render();
});

/* orders snapshot: keep it simple, admin sees all; hotel/customer views are filtered in renderOrders */
onSnapshot(collection(db, "orders"), snap => {
  orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

/* ---------- Event handling (single listener) ---------- */
document.addEventListener("click", async e => {
  const t = e.target;

  /* Add to cart */
  if (t.classList.contains("addToCart")) {
    const name = t.dataset.name, price = parseFloat(t.dataset.price), hotelId = t.dataset.hotel;
    cart.push({ name, price, hotelId });
    renderRestaurants();
    return;
  }

  /* Remove from cart */
  if (t.classList.contains("remove")) {
    const i = parseInt(t.dataset.i);
    cart.splice(i, 1);
    renderRestaurants();
    return;
  }

  /* Reset cart */
  if (t.id === "resetCart") { cart = []; renderRestaurants(); return; }

  /* Place order (customer) */
  if (t.id === "placeOrder") {
    const cname = document.getElementById("custName").value.trim();
    const cphone = document.getElementById("custPhone").value.trim();
    const mpesaName = (document.getElementById("mpesaName") && document.getElementById("mpesaName").value.trim()) || "";
    const mpesaNumber = (document.getElementById("mpesaNumber") && document.getElementById("mpesaNumber").value.trim()) || "";

    if (!cname || !cphone || cart.length === 0) return alert("Fill name/phone and add items");
    if (!mpesaName || !mpesaNumber) return alert("Enter M-PESA name and number");

    const itemsTotal = cart.reduce((s,i)=>s+i.price,0);
    const total = itemsTotal + SERVICE_FEE;
    await addDoc(collection(db, "orders"), {
      customerName: cname,
      customerPhone: cphone,
      items: cart,
      itemsTotal,
      serviceFee: SERVICE_FEE,
      serviceFeeTill: SERVICE_FEE_TILL,
      total,
      hotelId: cart[0].hotelId,
      status: "Pending",
      mpesaName,
      mpesaNumber,
      createdAt: Date.now()
    });

    alert("Order placed! Make sure you paid the hotel's till and entered the correct M-PESA details.");
    currentCustomer = { name: cname, phone: cphone };
    cart = [];
    switchTab("orders");
    render();
    return;
  }

  /* Logout hotel */
  if (t.id === "logoutHotel") { currentHotelId = null; render(); return; }

  /* Remove menu item (hotel) */
  if (t.classList.contains("removeMenu")) {
    const idx = parseInt(t.dataset.i);
    const rest = restaurants.find(r => r.hotelId === currentHotelId);
    if (!rest) return;
    rest.menu.splice(idx, 1);
    await setDoc(doc(db, "restaurants", rest.id), rest);
    renderHotelPortal();
    return;
  }

  /* Block/unblock hotel (admin) */
  if (t.classList.contains("toggleBlock")) {
    const hid = t.dataset.id;
    const hotelRef = doc(db, "hotels", hid);
    const hotel = hotels.find(h => h.id === hid);
    await updateDoc(hotelRef, { blocked: !hotel.blocked });
    return;
  }

  /* Approve hotel (admin) */
  if (t.classList.contains("approveHotel")) {
    const hid = t.dataset.id;
    await updateDoc(doc(db, "hotels", hid), { approved: true });
    // ensure restaurants doc exists
    const existing = restaurants.find(r => r.hotelId === hid);
    if (!existing) await setDoc(doc(db, "restaurants", hid), { hotelId: hid, menu: [] });
    return;
  }

  /* Mark as paid (hotel or admin) */
  if (t.classList.contains("markPaid")) {
    const oid = t.dataset.id;
    const order = orders.find(o => o.id === oid);
    if (!order) return alert("Order not found");
    if (currentHotelId && order.hotelId !== currentHotelId && !currentAdmin) return alert("No permission");
    await updateDoc(doc(db, "orders", oid), { status: "Paid" });
    alert("Order marked Paid.");
    return;
  }

  /* Delete order (admin or hotel) - permanent */
  if (t.classList.contains("deleteOrder")) {
    const oid = t.dataset.id;
    const order = orders.find(o => o.id === oid);
    if (!order) return alert("Order not found");
    if (!(currentAdmin || (currentHotelId && order.hotelId === currentHotelId))) return alert("No permission");
    if (confirm("Delete this order permanently?")) {
      await deleteDoc(doc(db, "orders", oid));
      alert("Order deleted.");
    }
    return;
  }

  /* Clear all data (admin) */
  if (t.id === "clearAll") {
    if (!confirm("Delete ALL hotels, restaurants, orders?")) return;
    const cols = ["hotels","restaurants","orders"];
    for (const c of cols) {
      const snap = await getDocs(collection(db, c));
      for (const d of snap.docs) await deleteDoc(doc(db, c, d.id));
    }
    alert("All cleared.");
    return;
  }
});

/* ---------- Form submissions (login/register/add menu) ---------- */
document.addEventListener("submit", async e => {
  e.preventDefault();
  const f = e.target;

  /* Hotel login */
  if (f.id === "hotelLogin") {
    const name = f.name.value.trim(), pass = f.pass.value.trim();
    const h = hotels.find(h => h.name === name && h.pass === pass);
    if (!h) return alert("Wrong credentials");
    if (!h.approved) return alert("Account pending admin approval");
    if (h.blocked) return alert("Account blocked by admin");
    currentHotelId = h.id;
    currentCustomer = null;
    switchTab("orders");
    render();
    return;
  }

  /* Hotel register */
  if (f.id === "hotelRegister") {
    const name = f.name.value.trim(), pass = f.pass.value.trim(), till = f.till.value.trim();
    if (!name || !pass || !till) return alert("Fill all fields");
    const docRef = await addDoc(collection(db, "hotels"), { name, pass, till, approved: false, blocked: false, subscriptionExpiry: Date.now() + 30*24*3600*1000 });
    // create restaurant doc (not visible until approved)
    await setDoc(doc(db, "restaurants", docRef.id), { hotelId: docRef.id, menu: [] });
    alert("Registered — waiting admin approval.");
    return;
  }

  /* Admin login */
  if (f.id === "adminLogin") {
    const u = f.user.value.trim(), p = f.pass.value.trim();
    if (u === ADMIN_CRED.user && p === ADMIN_CRED.pass) { currentAdmin = true; currentCustomer = null; switchTab("admin"); render(); }
    else alert("Wrong admin credentials");
    return;
  }

  /* Add menu (hotel) */
  if (f.id === "addMenu") {
    const name = f.name.value.trim(), price = parseFloat(f.price.value);
    if (!name || isNaN(price)) return alert("Fill valid item");
    const restRef = doc(db, "restaurants", currentHotelId);
    const rest = restaurants.find(r => r.hotelId === currentHotelId);
    if (rest) {
      const newMenu = [...(rest.menu || []), { name, price }];
      await setDoc(restRef, { ...rest, menu: newMenu });
    } else {
      await setDoc(doc(db, "restaurants", currentHotelId), { hotelId: currentHotelId, menu: [{ name, price }] });
    }
    renderHotelPortal();
    f.reset();
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tamu Express ‚Äî Ummeats</title>
  <script src="https://cdn.tailwindcss.com"></script>

<link rel="icon" type="image/png" href="https://i.ibb.co/KcFc8xn5/Gemini-Generated-Image-jokiqjjokiqjjoki.png">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

<header class="bg-green-600 text-white p-4 flex justify-between items-center">
  <h1 class="text-lg font-bold cursor-pointer">Tamu Express</h1>
  <nav class="space-x-2 flex items-center">
    <button class="tab px-3 py-1 rounded" data-tab="restaurants">Restaurants <span id="restBadge" class="ml-1"></span></button>
    <button class="tab px-3 py-1 rounded" data-tab="orders">Orders</button>
    <button class="tab px-3 py-1 rounded" data-tab="hotel">Hotel Portal <span id="hotelNotifBadge" class="ml-1"></span></button>
    <!-- Normal Button as a link -->
<a href="https://purinekaka70-svg.github.io/feedback.tamu/" target="_blank">
  <button> üç¥ Shop Here ‚Üí </button>
</a>
    <button class="tab px-3 py-1 rounded" data-tab="admin">Admin <span id="adminNotifBadge" class="ml-1"></span></button>
  </nav>
</header>
 
<marquee
  behavior="scroll"
  direction="left"
  scrollamount="6"
  class="bg-red-600 text-white font-semibold py-3 px-4 mt-2 rounded shadow mx-4"
>
  ‚ö†Ô∏è IMPORTANT NOTICE:
  Orders above KSh 400 attract a service fee of KSh 60.
  No morning orders are accepted.
  Lunch orders are accepted from 11:30 AM ‚Äì 2:00 PM.
  Evening orders are accepted from 4:00 PM ‚Äì 8:00 PM.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Kindly be adviced that if ordered food is not available,you're requested to browse and look for other replacemet or cantact customer care (0115613332).
  All confirmed orders will be delivered.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ÄúRamadhan is almost here! We are happy to inform everyone that vouchers for both morning and evening orders are now available at only KES 1,500. Karibuni sana as we prepare for this blessed month. We wish you all a peaceful and successful Ramadhan. For more information, please contact our customer care team on 0115613332 / 0116860686.‚Äù
</marquee>

<main id="app" class="p-4 flex-1"></main>
<footer id="footer" class="bg-gray-800 text-white p-3 text-center cursor-pointer">
  @ Tamu Express | Umma-Kenya 
</footer>

<!-- Cart / Checkout Modal container (hidden until needed) -->
<div id="cartModalContainer" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div id="cartModalBackdrop" class="absolute inset-0 bg-black opacity-50"></div>
  <div class="relative max-w-2xl w-full bg-white rounded shadow-lg p-4 z-60">
    <div id="cartModalContent"></div>
  </div>
</div>

<script type="module">

/* =========================
   TOAST SYSTEM (ADDED)
   ========================= */
   (function () {
  function toast(msg) {
    let c = document.getElementById("toast-container");
    if (!c) {
      c = document.createElement("div");
      c.id = "toast-container";
      c.style = "position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px";
      document.body.appendChild(c);
    }

    let bg = "#2563eb";
    if (/success|paid|activated|registered/i.test(msg)) bg = "#16a34a";
    if (/fail|error|blocked|wrong|expired/i.test(msg)) bg = "#dc2626";
    if (/pending|fill|max/i.test(msg)) bg = "#ca8a04";

    const t = document.createElement("div");
    t.textContent = msg;
    t.style = `
      background:${bg};
      color:#fff;
      padding:10px 14px;
      border-radius:6px;
      font-size:14px;
      box-shadow:0 4px 10px rgba(0,0,0,.2);
      opacity:0;
      transform:translateY(-10px);
      transition:.3s;
    `;
    c.appendChild(t);

    requestAnimationFrame(() => {
      t.style.opacity = 1;
      t.style.transform = "translateY(0)";
    });

    setTimeout(() => {
      t.style.opacity = 0;
      t.style.transform = "translateY(-10px)";
      setTimeout(() => t.remove(), 300);
    }, 3000);
  }

  // üî• override alert globally
  window.alert = (msg) => toast(msg);
})();

/* =========================
   YOUR ORIGINAL CODE
   (UNCHANGED BELOW)
   ========================= */
/* =========================
   Tamu Express ‚Äî Final working single-file
   - Firestore (modular v12)
   - Orders created from cart -> saved to "orders" collection
   - Orders tab reads from same "orders" collection (real-time)
   - Admin / Hotel / Customer views
   - Admin can Activate / Expire subscription now
   ========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, doc,
  onSnapshot, getDocs, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ---------- FIREBASE CONFIG (your keys) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyApi2RjwEXEW2mTwCMiYERKUNAYL8Toddk",
  authDomain: "tamuexpress-26e4a.firebaseapp.com",
  projectId: "tamuexpress-26e4a",
  storageBucket: "tamuexpress-26e4a.appspot.com",
  messagingSenderId: "202068792631",
  appId: "1:202068792631:web:8a9b97028ebd7a45af76b2"
}; 
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- STATE ---------- */
let hotels = [], restaurants = [], orders = [], notifications = [];
let cartByHotel = {}; // { hotelId: [ {name, price, qty} ] }
let currentTab = "restaurants";
let currentHotelId = null;
let currentAdmin = false;
let currentCustomer = null; // {name, phone} after placing an order
const SERVICE_FEE = 40;
const SERVICE_FEE_TILL = "0115613332  (Pochi Labiashara)";
const ADMIN_CRED = { user: "admin", pass: "TamuAdmin@2025" };

const appDiv = document.getElementById("app");
const adminTab = document.querySelector(".tab[data-tab='admin']");
adminTab.style.display = "none"; // hidden until footer 4x

/* Modal elements */
const cartModalContainer = document.getElementById('cartModalContainer');
const cartModalContent = document.getElementById('cartModalContent');

/* ---------- Helpers ---------- */
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".tab").forEach(b => {
    if (b.dataset.tab === tab) { b.classList.add("bg-white","text-green-700","font-semibold"); b.classList.remove("text-white"); }
    else { b.classList.remove("bg-white","text-green-700","font-semibold"); b.classList.add("text-white"); }
  });
  render();
}

function getHotelById(id) {
  return hotels.find(h => h.id === id) || { name: "Unknown", till: "N/A", approved: false, blocked: false };
}

function formatTime(ts) {
  try { return new Date(ts).toLocaleString('en-KE', { hour12: false }); } catch(e) { return String(ts); }
}

function escapeHtml(s) {
  if (s === undefined || s === null) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll("'",'&#39;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

// Normalizers for matching
function normalizeName(n) { return (n||"").toString().trim().toLowerCase(); }
function normalizePhone(p) { return (p||"").toString().replace(/\D/g,''); }

/* ---------- UI wiring ---------- */
document.querySelectorAll(".tab").forEach(b => b.addEventListener("click", () => switchTab(b.dataset.tab)));
let footerClicks = 0;
document.getElementById("footer").addEventListener("click", () => {
  footerClicks++;
  if (footerClicks >= 4) { adminTab.style.display = "inline-block"; switchTab("admin"); footerClicks = 0; }
});

/* ---------- Firestore listeners (real-time) ---------- */
/* Hotels */
onSnapshot(collection(db, "hotels"), snap => {
  hotels = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

/* Restaurants */
onSnapshot(collection(db, "restaurants"), snap => {
  restaurants = snap.docs.map(d => {
    const data = d.data();
    const hotel = getHotelById(data.hotelId);
    return { id: d.id, ...data, hotelName: hotel.name, till: hotel.till, approved: hotel.approved, blocked: hotel.blocked };
  });
  updateNotificationBadges();
  render();
});

/* Orders (real-time) */
onSnapshot(collection(db, "orders"), snap => {
  orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

/* Notifications */
onSnapshot(collection(db, "notifications"), snap => {
  notifications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  updateNotificationBadges();
  render();
});

/* ---------- Notification badges ---------- */
function updateNotificationBadges() {
  const adminUnread = notifications.filter(n => n.to === 'admin' && !n.read).length;
  const adminBadge = document.getElementById("adminNotifBadge");
  if (adminBadge) adminBadge.innerHTML = adminUnread ? `<span class="text-xs ml-1 bg-red-600 rounded-full px-2">${adminUnread}</span>` : "";

  const hotelUnread = currentHotelId ? notifications.filter(n => n.to === currentHotelId && !n.read).length : notifications.filter(n => n.to === 'hotel' && !n.read).length;
  const hotelBadge = document.getElementById("hotelNotifBadge");
  if (hotelBadge) hotelBadge.innerHTML = hotelUnread ? `<span class="text-xs ml-1 bg-red-600 rounded-full px-2">${hotelUnread}</span>` : "";

  const restBadge = document.getElementById("restBadge");
  if (restBadge) restBadge.innerHTML = restaurants.length ? `<span class="text-xs ml-1 bg-white text-green-700 rounded-full px-2">${restaurants.length}</span>` : "";
}

/* ---------- Rendering ---------- */
function render() {
  if (currentTab === "restaurants") renderRestaurants();
  else if (currentTab === "orders") renderOrders();
  else if (currentTab === "hotel") renderHotelPortal();
  else if (currentTab === "admin") renderAdmin();
}

/* Restaurants view */
function renderRestaurants() {
  const visible = restaurants.filter(r => r.approved && !r.blocked);
  appDiv.innerHTML = `
    <h2 class="text-xl font-semibold mb-3">All Restaurants</h2>
    <div class="grid md:grid-cols-2 gap-4">
      ${visible.map(r => `
      <div class="bg-white p-4 rounded shadow">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="font-bold">${escapeHtml(r.hotelName)}</h3>
            <p class="text-sm text-gray-500">Till: ${escapeHtml(r.till || "N/A")}</p>
          </div>
          <div class="flex items-center gap-2">
            <button class="viewMenuBtn bg-green-500 text-white px-3 py-1 rounded" data-hotel="${r.hotelId}">View Menu</button>
            <span class="text-sm">${(cartByHotel[r.hotelId] && cartByHotel[r.hotelId].length) ? `<span class="bg-gray-100 px-2 py-0.5 rounded">Cart: ${cartByHotel[r.hotelId].length}</span>` : ''}</span>
          </div>
        </div>
        <div id="menu-${r.hotelId}" class="menuArea mt-3 hidden"></div>
      </div>`).join("")}
    </div>
  `;
  visible.forEach(r => {
    const menuDiv = document.getElementById(`menu-${r.hotelId}`);
    if (!menuDiv) return;
    if (menuDiv.dataset && menuDiv.dataset.open === "true") {
      renderMenuForHotel(r.hotelId, menuDiv);
      menuDiv.classList.remove("hidden");
    }
  });
}

/* Render menu + cart for hotel */
function renderMenuForHotel(hotelId, container) {
  const rest = restaurants.find(rr => rr.hotelId === hotelId) || { menu: [] };
  const cart = cartByHotel[hotelId] || [];
  container.innerHTML = `
    <div class="transition-all">
      <div class="space-y-2">
        ${rest.menu && rest.menu.length ? rest.menu.map((item, idx) => `
          <div class="flex justify-between border-b py-2">
            <div><span class="font-medium">${escapeHtml(item.name)}</span><div class="text-xs text-gray-500">KSh ${item.price}</div></div>
            <div class="flex items-center gap-2">
              <input type="number" min="1" value="1" class="qty w-16 border p-1 text-sm" data-hotel="${hotelId}" data-idx="${idx}">
              <button class="addToCart bg-green-600 text-white px-3 py-1 rounded text-sm" data-hotel="${hotelId}" data-name="${item.name}" data-price="${item.price}">Add</button>
            </div>
          </div>`).join("") : `<p class="text-sm text-gray-500">No items yet</p>`}
      </div>

      <div class="bg-gray-50 p-3 rounded mt-3 border">
        <h4 class="font-semibold">Cart (${cart.length})</h4>
        ${cart.length === 0 ? "<p class='text-sm text-gray-500'>Empty cart</p>" : `
          <ul class="mb-2 text-sm">${cart.map((c,i) => `<li class="flex justify-between py-1"><span>${c.qty} x ${escapeHtml(c.name)}</span><span>KSh ${c.price * c.qty}</span> <button data-i="${i}" data-hotel="${hotelId}" class="removeItem text-red-500 ml-3 text-xs">x</button></li>`).join("")}</ul>
          <p class="text-sm">Items Total: KSh ${cart.reduce((s,i)=>s + (i.price * i.qty), 0)}</p>
          <p class="text-sm">Service Fee: KSh ${SERVICE_FEE}</p>
          <p class="text-sm">Pay food amount to: <strong>${escapeHtml(getHotelById(hotelId).till || "N/A")}</strong></p>
          <p class="text-sm">Service Fee Till: <strong>${escapeHtml(SERVICE_FEE_TILL)}</strong></p>
          <p class="font-semibold mt-2">Total to Pay: KSh ${cart.reduce((s,i)=>s + (i.price * i.qty), 0) + SERVICE_FEE}</p>

          <div class="mt-3">
            <input id="mpesaName-${hotelId}" class="border p-1 w-full mt-1 text-sm" placeholder="M-PESA name (as on payment)">
            <input id="mpesaNumber-${hotelId}" class="border p-1 w-full mt-2 text-sm" placeholder="M-PESA number (07XXXXXXXX)">
            <input id="custName-${hotelId}" class="border p-1 w-full mt-3 text-sm" placeholder="Your name">
            <input id="custPhone-${hotelId}" class="border p-1 w-full mt-2 text-sm" placeholder="Your phone">
            <div class="mt-2 flex gap-2">
              <button data-hotel="${hotelId}" class="placeOrder bg-blue-600 text-white px-3 py-1 rounded text-sm">Place Order</button>
              <button data-hotel="${hotelId}" class="resetCart bg-gray-600 text-white px-3 py-1 rounded text-sm">Reset</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Press "Place Order" to review & confirm. Closing the review returns you to the cart so you can add more items.</p>
          </div>
        `}
      </div>
    </div>
  `;
}

// ================= CUSTOMER PERSISTENCE =================
function getCustomerId() {
  let id = localStorage.getItem("CUSTOMER_ID");
  if (!id) {
    id = "cust_" + crypto.randomUUID();
    localStorage.setItem("CUSTOMER_ID", id);
  }
  return id;
}

//  MUST be defined BEFORE renderOrders()
const CUSTOMER_ID = getCustomerId();

/* Orders view */
function renderOrders() {
  let visibleOrders = [];

   // Decide which orders to show
  if (currentAdmin) {
    visibleOrders = [...orders];
  } else if (currentHotelId) {
    visibleOrders = orders.filter(o => o.hotelId === currentHotelId);
  } else {
    // CUSTOMER VIEW (persistent via CUSTOMER_ID)
    visibleOrders = orders.filter(o => o.customerId === CUSTOMER_ID);
  }

  // Sort orders by date (latest first)
  visibleOrders = visibleOrders.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

  // Build HTML
  appDiv.innerHTML = `
    <h2 class="text-xl font-semibold mb-3">Orders</h2>
    ${
      visibleOrders.length === 0
        ? "<p class='text-gray-500'>No orders yet</p>"
        : visibleOrders
            .map(o => {
              const hotel = getHotelById(o.hotelId) || { name: "Unknown Hotel", till: "N/A" };
              const itemsTotal = o.items
                ? o.items.reduce((s, i) => s + (i.price * (i.qty || 1)), 0)
                : 0;
              const total = o.total ?? (itemsTotal + (o.serviceFee ?? SERVICE_FEE));

              // Everyone (admin, hotel owner of order, or the ordering customer) can delete (even if Paid)
              const canDelete =
                currentAdmin ||
                (currentHotelId && currentHotelId === o.hotelId) ||
                (currentCustomer &&
                  normalizeName(currentCustomer.name) === normalizeName(o.customerName) &&
                  normalizePhone(currentCustomer.phone) === normalizePhone(o.customerPhone));

              const canMarkPaid =
                (currentHotelId && currentHotelId === o.hotelId) || currentAdmin;

              return `
                <div class="bg-white p-4 rounded shadow mb-3">
                  <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold">${escapeHtml(o.customerName)}</h3>
                    <div class="${ o.status === "Paid" ? "text-green-700 font-semibold" : "text-yellow-600 font-semibold" }">${o.status || "Pending"}</div>
                  </div>

                  <p class="text-sm text-gray-600">Phone: ${escapeHtml(o.customerPhone)}</p>
                  <p class="text-sm text-gray-600">Hotel: ${escapeHtml(hotel.name)} | Hotel Till: ${escapeHtml(hotel.till || "N/A")}</p>
                  <p class="text-xs text-gray-500">Ordered at: ${formatTime(o.createdAt)}</p>

                  ${
                    o.items
                      ? `<ul class="text-sm mt-2">
                          ${o.items
                            .map(
                              i =>
                                `<li>${i.qty ? i.qty + " x " : ""}${escapeHtml(i.name)} - KSh ${i.price}${i.qty ? " each" : ""}</li>`
                            )
                            .join("")}
                        </ul>`
                      : ""
                  }

                  <p class="text-sm mt-1">Items Total: KSh ${itemsTotal}</p>
                  <p class="text-sm mt-1">Service Fee: KSh ${o.serviceFee ?? SERVICE_FEE}</p>
                  <p class="text-sm mt-1">Service Fee Till: <strong>${SERVICE_FEE_TILL}</strong></p>
                  <p class="font-semibold mt-1">Total to Pay: KSh ${total}</p>

                  <div class="mt-2 text-sm">
                    <p><strong>M-PESA Name:</strong> ${escapeHtml(o.mpesaName || "‚Äî")}</p>
                    <p><strong>M-PESA Number:</strong> ${escapeHtml(o.mpesaNumber || "‚Äî")}</p>
                  </div>

                  <div class="mt-3 flex gap-2">
                    ${ canMarkPaid && o.status !== "Paid" ? `<button data-id="${o.id}" class="markPaid bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Mark as Paid</button>` : "" }
                    ${ canDelete ? `<button data-id="${o.id}" class="deleteOrder bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>` : "" }
                  </div>
                </div>
              `;
            })
            .join("")
    }
  `;
}

/* Hotel portal */
function renderHotelPortal() {
  if (!currentHotelId) {
    appDiv.innerHTML = `
      <div class="grid md:grid-cols-2 gap-4">
        <form id="hotelLogin" class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-2">Hotel Login</h3>
          <input name="name" placeholder="Hotel name" class="border p-2 w-full mb-2">
          <input name="pass" placeholder="Password" type="password" class="border p-2 w-full mb-2">
          <button class="bg-green-600 text-white px-3 py-1 rounded" type="submit">Login</button>
        </form>
        <form id="hotelRegister" class="bg-white p-4 rounded shadow">
          <h3 class="font-semibold mb-2">Register</h3>
          <input name="name" placeholder="Hotel name" class="border p-2 w-full mb-2">
          <input name="phone" placeholder="Phone number (07...)" class="border p-2 w-full mb-2">
          <input name="pass" placeholder="Password" type="password" class="border p-2 w-full mb-2">
          <input name="till" placeholder="Till number (e.g. 123456)" class="border p-2 w-full mb-2">
          <button class="bg-blue-600 text-white px-3 py-1 rounded" type="submit">Register</button>
        </form>
      </div>
    `;
    return;
  }

  const hotel = hotels.find(h => h.id === currentHotelId);
  if (!hotel) return;
  if (hotel.blocked) {
    appDiv.innerHTML = `<div class="bg-white p-4 rounded shadow"><p class="text-red-600 font-bold">Blocked by admin</p><button id="logoutHotel" class="mt-3 bg-red-500 text-white px-3 py-1 rounded">Logout</button></div>`;
    return;
  }
  // subscription logic still present: hotel cannot use portal if expired
  if (!hotel.subscriptionExpiry || hotel.subscriptionExpiry < Date.now()) {
    appDiv.innerHTML = `<div class="bg-white p-4 rounded shadow"><p class="text-red-600 font-bold">Subscription expired. Contact admin to reactivate.</p><button id="logoutHotel" class="mt-3 bg-red-500 text-white px-3 py-1 rounded">Logout</button></div>`;
    return;
  }

  const hotelNotifs = notifications.filter(n => n.to === currentHotelId);
  const rest = restaurants.find(r => r.hotelId === currentHotelId) || { menu: [] };

  appDiv.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-bold">${escapeHtml(hotel.name)}</h2>
      <div class="flex items-center gap-2">
        <div class="relative">
          <button id="showHotelNotifs" class="bg-white text-gray-700 px-3 py-1 rounded">Notifications ${hotelNotifs.filter(n=>!n.read).length ? `<span class="text-xs ml-1 bg-red-600 rounded-full px-2 text-white">${hotelNotifs.filter(n=>!n.read).length}</span>` : ''}</button>
          <div id="hotelNotifBox" class="hidden absolute right-0 mt-2 w-80 bg-white rounded shadow p-2 z-50"></div>
        </div>
        <button id="logoutHotel" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
      </div>
    </div>

    <div class="bg-white p-4 rounded shadow mb-4">
      <form id="addMenu" class="flex gap-2">
        <input name="name" placeholder="Item name" class="border p-2 flex-1" />
        <input name="price" type="number" placeholder="Price" class="border p-2 w-24" />
        <button class="bg-green-600 text-white px-3 py-1 rounded" type="submit">Add</button>
      </form>
      <ul class="mt-3">
        ${rest.menu.map((m,i)=>`<li>${escapeHtml(m.name)} - KSh ${m.price} <button data-i="${i}" class="removeMenu text-red-500 ml-2">x</button></li>`).join("")}
      </ul>
    </div>

    <div>
      <h3 class="font-semibold mb-2">Orders for ${escapeHtml(hotel.name)}</h3>
      <div id="hotelOrdersArea">${renderHotelOrdersHtml(currentHotelId)}</div>
    </div>
  `;

  const notifBox = document.getElementById("hotelNotifBox");
  notifBox.innerHTML = hotelNotifs.length === 0 ? `<p class="text-sm text-gray-500">No notifications</p>` : hotelNotifs.map(n => `
    <div class="border-b py-2">
      <div class="text-sm">${escapeHtml(n.message)}</div>
      <div class="text-xs text-gray-500">${formatTime(n.timestamp)}</div>
      <div class="mt-1">
        ${!n.read ? `<button data-id="${n.id}" class="markNotifRead text-xs text-blue-600">Mark read</button>` : `<span class="text-xs text-gray-400">Read</span>`}
      </div>
    </div>
  `).join("");
}

function renderHotelOrdersHtml(hid) {
  const hotelOrders = orders.filter(o => o.hotelId === hid).sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
  if (hotelOrders.length === 0) return `<p class="text-sm text-gray-500">No orders yet</p>`;
  return hotelOrders.map(o => `
    <div class="bg-white p-3 rounded mb-2">
      <div class="flex justify-between items-center">
        <div>
          <div class="font-semibold">${escapeHtml(o.customerName)}</div>
          <div class="text-xs text-gray-500">${formatTime(o.createdAt)}</div>
        </div>
        <div class="text-sm ${o.status === 'Paid' ? 'text-green-700' : 'text-yellow-600'}">${o.status || 'Pending'}</div>
      </div>
      <div class="text-sm mt-2">${o.items.map(i => `<div>${i.qty ? i.qty + ' x ' : ''}${escapeHtml(i.name)} - KSh ${i.price}</div>`).join("")}</div>
      <div class="mt-2 flex gap-2">
        ${o.status !== 'Paid' ? `<button data-id="${o.id}" class="markPaid bg-green-600 text-white px-2 py-1 rounded text-sm">Mark Paid</button>` : ''}
        <button data-id="${o.id}" class="deleteOrder bg-red-600 text-white px-2 py-1 rounded text-sm">Delete</button>
      </div>
    </div>
  `).join("");
}

/* Admin */
function renderAdmin() {
  if (!currentAdmin) {
    appDiv.innerHTML = `
      <form id="adminLogin" class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Admin Login</h3>
        <input name="user" placeholder="Username" class="border p-2 w-full mb-2">
        <input name="pass" placeholder="Password" type="password" class="border p-2 w-full mb-2">
        <button class="bg-purple-600 text-white px-3 py-1 rounded" type="submit">Login</button>
      </form>`;
    return;
  }

  const adminNotifs = notifications.filter(n => n.to === 'admin');

  appDiv.innerHTML = `
    <h2 class="text-xl font-semibold mb-3">Admin Panel</h2>
    <div class="mb-4 flex gap-2 items-center">
      <button id="clearAll" class="bg-red-700 text-white px-3 py-1 rounded">Clear All Data</button>
      <div class="relative">
        <button id="showAdminNotifs" class="bg-white text-gray-700 px-3 py-1 rounded">Notifications ${adminNotifs.filter(n=>!n.read).length ? `<span class="text-xs ml-1 bg-red-600 rounded-full px-2 text-white">${adminNotifs.filter(n=>!n.read).length}</span>` : ''}</button>
        <div id="adminNotifBox" class="hidden absolute right-0 mt-2 w-96 bg-white rounded shadow p-2 z-50"></div>
      </div>
    </div>

    <h3 class="font-semibold mb-2">Registered Hotels</h3>
    ${hotels.map(h => {
      const active = h.subscriptionExpiry && h.subscriptionExpiry >= Date.now();
      return `<div class="bg-white p-3 rounded shadow mb-2 flex justify-between items-center">
        <div>
          <p class="font-semibold">${escapeHtml(h.name)}</p>
          <p>Till: ${escapeHtml(h.till)}</p>
          <p>Blocked: ${h.blocked ? "Yes" : "No"}</p>
          <p>Approved: ${h.approved ? "Yes" : "No"}</p>
          <p>Subscription: ${active ? "Active" : "Expired" } ${h.subscriptionExpiry ? `(${new Date(h.subscriptionExpiry).toLocaleDateString()})` : ''}</p>
        </div>
        <div class="flex gap-2">
          <button data-id="${h.id}" class="toggleBlock bg-red-500 text-white px-2 py-1 rounded">${h.blocked ? "Unblock" : "Block"}</button>
          ${!h.approved ? `<button data-id="${h.id}" class="approveHotel bg-green-500 text-white px-2 py-1 rounded">Approve</button>` : ''}
          <button data-id="${h.id}" class="activateSub bg-blue-600 text-white px-2 py-1 rounded">Activate</button>
          <button data-id="${h.id}" class="expireSub bg-gray-600 text-white px-2 py-1 rounded">Expire Now</button>
        </div>
      </div>`;
    }).join("")}

    <h3 class="font-semibold mt-4 mb-2">Orders</h3>
    <div><button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="switchTab('orders')">Go to Orders</button></div>
  `;

  const adminNotifBox = document.getElementById("adminNotifBox");
  adminNotifBox.innerHTML = adminNotifs.length === 0 ? `<p class="text-sm text-gray-500">No notifications</p>` : adminNotifs.map(n => `
    <div class="border-b py-2">
      <div class="text-sm">${escapeHtml(n.message)}</div>
      <div class="text-xs text-gray-500">${formatTime(n.timestamp)}</div>
      <div class="mt-1">
        ${!n.read ? `<button data-id="${n.id}" class="markNotifRead text-xs text-blue-600">Mark read</button>` : `<span class="text-xs text-gray-400">Read</span>`}
      </div>
    </div>
  `).join("");
}

/* ---------- Event delegation ---------- */
document.addEventListener("click", async e => {
  const t = e.target;

  // toggle menu view
  if (t.classList.contains("viewMenuBtn")) {
    const hid = t.dataset.hotel;
    const menuDiv = document.getElementById(`menu-${hid}`);
    if (!menuDiv) return;
    const isOpen = menuDiv.dataset.open === "true";
    if (isOpen) {
      menuDiv.dataset.open = "false";
      menuDiv.classList.add("hidden");
    } else {
      menuDiv.dataset.open = "true";
      menuDiv.classList.remove("hidden");
      renderMenuForHotel(hid, menuDiv);
    }
    return;
  }

  // add to cart
  if (t.classList.contains("addToCart")) {
    const hotelId = t.dataset.hotel;
    const name = t.dataset.name;
    const price = parseFloat(t.dataset.price);
    const row = t.closest('div');
    let qty = 1;
    try { const qtyInput = row?.querySelector('.qty'); if (qtyInput) qty = Math.max(1, parseInt(qtyInput.value) || 1); } catch(e) {}
    cartByHotel[hotelId] = cartByHotel[hotelId] || [];
    const existing = cartByHotel[hotelId].find(c => c.name === name && c.price === price);
    if (existing) existing.qty += qty;
    else cartByHotel[hotelId].push({ name, price, qty });
    const menuDiv = document.getElementById(`menu-${hotelId}`);
    if (menuDiv) renderMenuForHotel(hotelId, menuDiv);
    updateNotificationBadges();

    alert("Item added to cart");
    return;
  }

  // remove item from cart
  if (t.classList.contains("removeItem")) {
    const hotelId = t.dataset.hotel;
    const i = parseInt(t.dataset.i);
    if (!cartByHotel[hotelId]) return;
    cartByHotel[hotelId].splice(i, 1);
    const menuDiv = document.getElementById(`menu-${hotelId}`);
    if (menuDiv) renderMenuForHotel(hotelId, menuDiv);
    return;
  }

  // reset cart
  if (t.classList.contains("resetCart")) {
    const hotelId = t.dataset.hotel;
    cartByHotel[hotelId] = [];
    const menuDiv = document.getElementById(`menu-${hotelId}`);
    if (menuDiv) renderMenuForHotel(hotelId, menuDiv);
    return;
  }
 
 // place order -> open modal
 if (t.classList.contains("placeOrder")) {
    const hotelId = t.dataset.hotel;
    openCartModal(hotelId);
    return;
  }

if (t.classList.contains("deleteOrder")) {
  const oid = t.dataset.id;
  const order = orders.find(o => o.id === oid);
  if (!order) return alert("Order not found");

  const isCustomerOwner = order.customerId === CUSTOMER_ID;
  const allowed =
    currentAdmin ||
    (currentHotelId && order.hotelId === currentHotelId) ||
    isCustomerOwner;

  if (!allowed) return alert("No permission to delete this order");
  if (!confirm("Delete this order permanently?")) return;

  try {
    await deleteDoc(doc(db, "orders", oid));
    alert("Order deleted permanently");
  } catch (err) {
    console.error(err);
    alert("Delete failed");
  }
}


  // mark paid
  if (t.classList.contains("markPaid")) {
    const oid = t.dataset.id;
    const order = orders.find(o => o.id === oid);
    if (!order) return alert("Order not found");
    if (currentHotelId && order.hotelId !== currentHotelId && !currentAdmin) return alert("No permission");
    try {
      await updateDoc(doc(db, "orders", oid), { status: "Paid" });
      alert("Order marked Paid.");
    } catch (err) {
      console.error("Mark paid failed", err);
      alert("Failed to mark paid. Check console.");
    }
    return;
  }

  // remove menu item (hotel)
  if (t.classList.contains("removeMenu")) {
    const idx = parseInt(t.dataset.i);
    const rest = restaurants.find(r => r.hotelId === currentHotelId);
    if (!rest) return;
    rest.menu.splice(idx, 1);
    await setDoc(doc(db, "restaurants", rest.id), rest);
    render();
    return;
  }

  // block/unblock hotel (admin)
  if (t.classList.contains("toggleBlock")) {
    const hid = t.dataset.id;
    const hotelRef = doc(db, "hotels", hid);
    const hotel = hotels.find(h => h.id === hid);
    await updateDoc(hotelRef, { blocked: !hotel.blocked });
    return;
  }

  // approve hotel (admin)
  if (t.classList.contains("approveHotel")) {
    const hid = t.dataset.id;
    await updateDoc(doc(db, "hotels", hid), { approved: true });
    const existing = restaurants.find(r => r.hotelId === hid);
    if (!existing) await setDoc(doc(db, "restaurants", hid), { hotelId: hid, menu: [] });
    return;
  }

  // Activate subscription (admin)
  if (t.classList.contains("activateSub")) {
    const hid = t.dataset.id;
    const expiry = Date.now() + 30*24*60*60*1000; // +30 days
    try {
      await updateDoc(doc(db, "hotels", hid), { subscriptionExpiry: expiry });
      alert("Subscription activated for 30 days.");
    } catch(err) {
      console.error("Activate failed", err);
      alert("Failed to activate subscription. Check console.");
    }
    return;
  }

  // Expire subscription now (admin)
  if (t.classList.contains("expireSub")) {
    const hid = t.dataset.id;
    try {
      await updateDoc(doc(db, "hotels", hid), { subscriptionExpiry: Date.now() - 1000 });
      alert("Subscription expired.");
    } catch(err) {
      console.error("Expire failed", err);
      alert("Failed to expire subscription. Check console.");
    }
    return;
  }

  // clear all (admin)
  if (t.id === "clearAll") {
    if (!confirm("Delete ALL hotels, restaurants, orders, notifications?")) return;
    const cols = ["hotels","restaurants","orders","notifications"];
    for (const c of cols) {
      const snap = await getDocs(collection(db, c));
      for (const d of snap.docs) await deleteDoc(doc(db, c, d.id));
    }
    alert("All cleared.");
    return;
  }

  // logout hotel
  if (t.id === "logoutHotel") { currentHotelId = null; render(); return; }

  // mark notification read
  if (t.classList.contains("markNotifRead")) {
    const nid = t.dataset.id;
    await updateDoc(doc(db, "notifications", nid), { read: true });
    return;
  }

  // show hotel notif dropdown
  if (t.id === "showHotelNotifs") {
    const box = document.getElementById("hotelNotifBox");
    if (box) box.classList.toggle("hidden");
    return;
  }

  // show admin notif dropdown
  if (t.id === "showAdminNotifs") {
    const box = document.getElementById("adminNotifBox");
    if (box) box.classList.toggle("hidden");
    return;
  }

  // confirm order (modal)
  if (t.id === 'confirmOrderBtn') {
    const hotelId = t.dataset.hotel;
    await handlePlaceOrder(hotelId, { clearCartAfter: false, closeModal: true });
    return;
  }

  // close cart modal (return to cart)
  if (t.id === 'closeCartModal' || t.id === 'cartModalBackdrop') {
    closeCartModal();
    return;
  }
});

/* ---------- Form submissions ---------- */
document.addEventListener("submit", async e => {
  e.preventDefault();
  const f = e.target;

  // hotel login
 // hotel register FIXED
if (f.id === "hotelRegister") {
  const name = f.name.value.trim();
  const phone = f.phone.value.trim();
  const pass = f.pass.value.trim();
  const till = f.till.value.trim();

  if (!name || !phone || !pass || !till)
    return alert("Fill all fields including phone number");

  try {
    const docRef = await addDoc(collection(db, "hotels"), {
      name,
      phone, //  SAVED
      pass,
      till,
      approved: true,
      blocked: false,
      subscriptionExpiry: Date.now() + 30 * 24 * 60 * 60 * 1000
    });

    await setDoc(doc(db, "restaurants", docRef.id), {
      hotelId: docRef.id,
      menu: []
    });

    alert("Registered ‚Äî waiting admin approval.");
    f.reset();
  } catch (err) {
    console.error(err);
    alert("Registration failed");
  }

  return;
}
// hotel login
if (f.id === "hotelLogin") {
  const name = f.name.value.trim();
  const pass = f.pass.value.trim();

  if (!name || !pass)
    return alert("Enter hotel name and password");

  const hotel = hotels.find(
    h => h.name === name && h.pass === pass
  );

  if (!hotel)
    return alert("Wrong hotel name or password");

  if (!hotel.approved)
    return alert("Hotel not approved yet");

  if (hotel.blocked)
    return alert("Hotel is blocked");

  if (!hotel.subscriptionExpiry || hotel.subscriptionExpiry < Date.now())
    return alert("Subscription expired. Contact admin");

  currentHotelId = hotel.id;
  currentAdmin = false;
  currentCustomer = null;

  alert("Login successful");
  switchTab("hotel");
  render();
  return;
}

  // admin login
  if (f.id === "adminLogin") {
    const u = f.user.value.trim(), p = f.pass.value.trim();
    if (u === ADMIN_CRED.user && p === ADMIN_CRED.pass) { currentAdmin = true; currentCustomer = null; switchTab("admin"); render(); }
    else alert("Wrong admin credentials");
    return;
  }

  // add menu (hotel)
  if (f.id === "addMenu") {
    const name = f.name.value.trim(), price = parseFloat(f.price.value);
    if (!name || isNaN(price)) return alert("Fill valid item");
    const restRef = doc(db, "restaurants", currentHotelId);
    const rest = restaurants.find(r => r.hotelId === currentHotelId);
    if (rest) {
      const newMenu = [...(rest.menu || []), { name, price }];
      await setDoc(restRef, { ...rest, menu: newMenu });
    } else {
      await setDoc(doc(db, "restaurants", currentHotelId), { hotelId: currentHotelId, menu: [{ name, price }] });
    }
    render();
    f.reset();
    return;
  }
});

/* ---------- Cart modal helpers ---------- */
function openCartModal(hotelId) {
  const cart = cartByHotel[hotelId] || [];
  if (!cart || cart.length === 0) return alert("Cart empty");
  const itemsTotal = cart.reduce((s,i) => s + (i.price * (i.qty || 1)), 0);
  const total = itemsTotal + SERVICE_FEE;
  const mpesaNameVal = document.getElementById(`mpesaName-${hotelId}`)?.value || '';
  const mpesaNumberVal = document.getElementById(`mpesaNumber-${hotelId}`)?.value || '';
  const custNameVal = document.getElementById(`custName-${hotelId}`)?.value || '';
  const custPhoneVal = document.getElementById(`custPhone-${hotelId}`)?.value || '';

  cartModalContent.innerHTML = `
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-semibold">Confirm Order - ${escapeHtml(getHotelById(hotelId).name)}</h3>
      <button id="closeCartModal" class="text-gray-500 hover:text-gray-800">Close</button>
    </div>
    <div class="max-h-64 overflow-auto text-sm mb-3">
      ${cart.map(i => `<div class="flex justify-between py-1"><div>${i.qty} x ${escapeHtml(i.name)}</div><div>KSh ${i.price * i.qty}</div></div>`).join('')}
    </div>
    <div class="text-sm mb-2">
      <div>Items Total: KSh ${itemsTotal}</div>
      <div>Service Fee: KSh ${SERVICE_FEE}</div>
      <div class="font-semibold">Total: KSh ${total}</div>
    </div>

    <div class="space-y-2 mb-3">
      <input id="modalMpesaName" value="${escapeHtml(mpesaNameVal)}" placeholder="M-PESA name" class="border p-2 w-full text-sm" />
      <input id="modalMpesaNumber" value="${escapeHtml(mpesaNumberVal)}" placeholder="M-PESA number" class="border p-2 w-full text-sm" />
      <input id="modalCustName" value="${escapeHtml(custNameVal)}" placeholder="Your name" class="border p-2 w-full text-sm" />
      <input id="modalCustPhone" value="${escapeHtml(custPhoneVal)}" placeholder="Your phone" class="border p-2 w-full text-sm" />
    </div>

    <div class="flex gap-2">
      <button id="confirmOrderBtn" data-hotel="${hotelId}" class="bg-blue-600 text-white px-3 py-1 rounded">Confirm Order</button>
      <button id="closeCartModal" class="bg-gray-300 px-3 py-1 rounded">Return to Cart</button>
    </div>

    <p class="text-xs text-gray-500 mt-3">Note: closing this dialog returns you to the cart so you can add more food. You can place multiple orders without losing cart contents.</p>
  `;

  cartModalContainer.classList.remove('hidden');
  cartModalContainer.classList.add('flex');
}

function closeCartModal() {
  cartModalContainer.classList.add('hidden');
  cartModalContainer.classList.remove('flex');
  cartModalContent.innerHTML = '';
}

/* ---------- Place order (writes to Firestore orders collection) ---------- */
async function handlePlaceOrder(hotelId, options = { clearCartAfter: false, closeModal: true }) {
  const cart = cartByHotel[hotelId] || [];
  if (!cart || cart.length === 0) { closeCartModal(); return alert("Cart empty"); }

  const mpesaNameInputModal = document.getElementById('modalMpesaName');
  const mpesaNumberInputModal = document.getElementById('modalMpesaNumber');
  const custNameInputModal = document.getElementById('modalCustName');
  const custPhoneInputModal = document.getElementById('modalCustPhone');

  const mpesaName = mpesaNameInputModal ? mpesaNameInputModal.value.trim() : (document.getElementById(`mpesaName-${hotelId}`)?.value.trim() || "");
  const mpesaNumber = mpesaNumberInputModal ? mpesaNumberInputModal.value.trim() : (document.getElementById(`mpesaNumber-${hotelId}`)?.value.trim() || "");
  const cname = custNameInputModal ? custNameInputModal.value.trim() : (document.getElementById(`custName-${hotelId}`)?.value.trim() || "");
  const cphone = custPhoneInputModal ? custPhoneInputModal.value.trim() : (document.getElementById(`custPhone-${hotelId}`)?.value.trim() || "");

  if (!cname || !cphone) return alert("Fill your name and phone");
  if (!mpesaName || !mpesaNumber) return alert("Enter M-PESA name and number for service fee");

  // limit pending orders to 100 (server-side enforcement would be better, but we check here)
  const snap = await getDocs(collection(db, "orders"));
  const allOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  const pendingCount = allOrders.filter(o => (o.status || 'Pending') !== 'Paid').length;
  if (pendingCount >= 100) return alert("Sorry, maximum pending orders reached. Try again later.");

  const itemsTotal = cart.reduce((s,i) => s + (i.price * (i.qty || 1)), 0);
  const total = itemsTotal + SERVICE_FEE;

  const orderPayload = {
    customerId: CUSTOMER_ID,
    customerName: cname,
    customerPhone: cphone,
    items: cart.map(i => ({ name: i.name, price: i.price, qty: i.qty || 1 })),
    itemsTotal,
    serviceFee: SERVICE_FEE,
    serviceFeeTill: SERVICE_FEE_TILL,
    total,
    hotelId,
    status: "Pending",
    mpesaName,
    mpesaNumber,
    createdAt: Date.now()
  };

  // set currentCustomer BEFORE writing so realtime listener + render can show the order immediately
  currentCustomer = { name: cname, phone: cphone };

  // Write order to Firestore (orders listener will refresh UI)
  try {
    await addDoc(collection(db, "orders"), orderPayload);
    sendSimulatedHotelSMS(hotelId, {
  customerName: cname,
  customerPhone: cphone,
  total: total
});

    alert("Order placed successfully ");

  } catch (err) {
    console.error("Order write failed", err);
    alert("Failed to place order. Check console.");
    return;
  }

  // Create notifications
  const hotel = getHotelById(hotelId);
  const message = `New order from ${cname} (${cphone}) ‚Äî KSh ${total} for ${hotel.name}`;
  try {
    await addDoc(collection(db, "notifications"), { type: "order", to: "admin", message, timestamp: Date.now(), read: false });
    await addDoc(collection(db, "notifications"), { type: "order", to: hotelId, message, timestamp: Date.now(), read: false });
  } catch (err) {
    console.warn("Notification write failed", err);
  }

  // Optionally clear cart after placing (we keep per your earlier request)
  if (options.clearCartAfter) cartByHotel[hotelId] = [];

  if (options.closeModal) closeCartModal();

  // switch to Orders so user sees it immediately (orders list is realtime and currentCustomer is set)
  switchTab("orders");
  render();
}

/* ---------- Initialize ---------- */
updateNotificationBadges();
render(); 

/* =========================================================
   SIMULATED SMS SYSTEM (FIREBASE-BASED)
   ========================================================= */

   const SMS_SIMULATION_ENABLED = true;

/* SEND SMS TO HOTEL */
function sendSimulatedHotelSMS(hotelId, order) {
  if (!SMS_SIMULATION_ENABLED) return;

  const hotel = hotels.find(h => h.id === hotelId);

  if (!hotel || !hotel.phone) {
    console.warn("Hotel phone missing, SMS not sent");
    return;
  }

  const message =
    "üì© NEW ORDER RECEIVED\n\n" +
    "Hotel: " + hotel.name + "\n" +
    "Customer: " + order.customerName + "\n" +
    "Customer Phone: " + order.customerPhone + "\n" +
    "Total Amount: KSh " + order.total + "\n\n" +
    "Please check your dashboard.";

  const sms = {
    to: hotel.phone,
    hotelId: hotelId,
    message,
    time: new Date().toLocaleString()
  };

  // store SMS locally (simulation inbox)
  const inbox = JSON.parse(localStorage.getItem("SIMULATED_SMS_INBOX")) || [];
  inbox.push(sms);
  localStorage.setItem("SIMULATED_SMS_INBOX", JSON.stringify(inbox));

  alert(
    "üì© SIMULATED SMS SENT\n\n" +
    "To: " + hotel.phone + "\n\n" +
    message
  );

  console.log("üì© SIMULATED SMS:", sms);
}

/* VIEW ALL SIMULATED SMS */
function viewSimulatedSMSInbox() {
  const inbox = JSON.parse(localStorage.getItem("SIMULATED_SMS_INBOX")) || [];

  if (inbox.length === 0)
    return alert(" No SMS messages yet");

  let output = " SIMULATED SMS INBOX\n\n";
  inbox.forEach((sms, i) => {
    output +=
      (i + 1) + ". To: " + sms.to + "\n" +
      sms.message + "\n" +
      "Time: " + sms.time + "\n\n";
  });

  alert(output);
}

</script>
</body>
</html>

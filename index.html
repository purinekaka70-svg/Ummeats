<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tamu Express</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY",
  authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
  projectId: "YOUR_FIREBASE_PROJECT_ID",
  storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
  messagingSenderId: "YOUR_FIREBASE_SENDER_ID",
  appId: "YOUR_FIREBASE_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let hotels = [];
let cart = [];
const SERVICE_NUMBER = "0115613332";
const SERVICE_FEE = 20;

const appEl = document.getElementById("app");

// Load all hotels
async function loadHotels(){
  const snapshot = await getDocs(collection(db, "hotels"));
  hotels = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
}

// Render homepage (customer)
function renderRestaurants(){
  appEl.innerHTML = `
    <header class="bg-green-600 text-white p-4 flex justify-between">
      <h1 class="font-bold text-lg">üçî Tamu Express</h1>
      <button id="toAdmin" class="bg-black px-2 py-1 rounded">Admin</button>
    </header>
    <main class="p-4 grid gap-4">
      ${hotels.map(h => `
        <div class="bg-white p-4 rounded shadow">
          <h2 class="font-bold">${h.name}</h2>
          <p>Till: ${h.till}</p>
          <button data-hid="${h.id}" class="orderBtn bg-green-600 text-white px-3 py-1 rounded mt-2">Order</button>
        </div>
      `).join("")}
    </main>
  `;
}

// Render hotel order page
function renderHotelOrders(hotelId){
  appEl.innerHTML = `
    <header class="bg-green-700 text-white p-4 flex justify-between">
      <h1 class="font-bold">Hotel Dashboard</h1>
      <button id="logoutHotel" class="bg-red-500 px-3 py-1 rounded">Logout</button>
    </header>
    <main id="ordersContainer" class="p-4 space-y-4">
      <h2 class="font-semibold text-lg">Orders</h2>
      <p>Loading...</p>
    </main>
  `;
  loadHotelOrders(hotelId);
}

// Load hotel-specific orders
async function loadHotelOrders(hotelId){
  const q = await getDocs(collection(db, "orders"));
  const orders = q.docs.map(d => ({id: d.id, ...d.data()})).filter(o => o.hotelId === hotelId);
  const container = document.getElementById("ordersContainer");
  container.innerHTML = orders.length ? orders.map(o => `
    <div class="border rounded p-3 bg-white shadow">
      <p><b>Customer:</b> ${o.customerName}</p>
      <p><b>Phone:</b> ${o.customerPhone}</p>
      <p><b>Total:</b> ${o.total}</p>
      <p><b>Status:</b> ${o.status}</p>
      <button data-id="${o.id}" class="markPaid bg-green-600 text-white px-3 py-1 rounded mt-2">Mark as Paid</button>
    </div>
  `).join("") : `<p>No orders yet.</p>`;
}

// Admin page
function renderAdmin(){
  appEl.innerHTML = `
  <header class="bg-gray-800 text-white p-4 flex justify-between items-center">
    <h1 class="font-bold text-lg">Admin Panel</h1>
    <div class="flex gap-2">
      <button id="clearAll" class="bg-yellow-500 px-3 py-1 rounded">üóë Clear All</button>
      <button id="logoutAdmin" class="bg-red-500 px-3 py-1 rounded">Logout</button>
    </div>
  </header>

  <main class="p-4 space-y-4">
    <h2 class="font-semibold text-lg">Hotels</h2>
    ${hotels.map(h=>`
      <div class="border p-3 rounded bg-white shadow flex justify-between items-center">
        <div>
          <p><b>${h.name}</b> (Till: ${h.till})</p>
          <p>Status: ${h.approved ? "‚úÖ Approved" : "‚è≥ Pending"} | ${h.blocked ? "‚ùå Blocked" : "üü¢ Active"}</p>
        </div>
        <div class="flex gap-2">
          <button data-id="${h.id}" class="toggleBlock bg-red-500 text-white px-2 py-1 rounded">${h.blocked?"Unblock":"Block"}</button>
          ${!h.approved?`<button data-id="${h.id}" class="approveHotel bg-green-500 text-white px-2 py-1 rounded">Approve</button>`:""}
        </div>
      </div>
    `).join("")}
  </main>`;
}

// ========== EVENTS ==========
document.addEventListener("click", async e=>{
  const t = e.target;

  // Admin view
  if(t.id==="toAdmin"){ renderAdmin(); }

  // Mark order as paid
  if(t.classList.contains("markPaid")){
    const id = t.dataset.id;
    await updateDoc(doc(db, "orders", id), {status:"Paid"});
    alert("‚úÖ Order marked as paid!");
    const hotelId = JSON.parse(localStorage.getItem("hotelLogin"));
    loadHotelOrders(hotelId);
  }

  // Order button
  if(t.classList.contains("orderBtn")){
    const h = hotels.find(h=>h.id===t.dataset.hid);
    const name = prompt("Enter your name:");
    const phone = prompt("Enter your phone:");
    if(!name || !phone) return alert("Enter name and phone!");

    const total = 100 + SERVICE_FEE;
    await addDoc(collection(db,"orders"), {
      customerName:name,
      customerPhone:phone,
      items:[{item:"Sample Meal",price:100}],
      total,
      hotelId:h.id,
      hotelTill:h.till,
      serviceNumber:SERVICE_NUMBER,
      status:"Pending"
    });

    alert(
      `Order placed!\n\n` +
      `üç¥ Hotel Till Number: ${h.till}\n` +
      ` Pay Service Fee (Ksh ${SERVICE_FEE}) to: Pochi Labiashara ${SERVICE_NUMBER}\n\n` +
      `You'll be called when your order is ready.`
    );
  }

  // Clear all data (admin)
  if(t.id === "clearAll"){
    if(confirm(" Are you sure? This will delete ALL hotels, restaurants, and orders!")){
      const collections = ["hotels", "restaurants", "orders"];
      for(const col of collections){
        const snapshot = await getDocs(collection(db, col));
        for(const d of snapshot.docs){
          await deleteDoc(doc(db, col, d.id));
        }
      }
      alert("All data cleared successfully!");
      renderAdmin();
    }
  }
});

// Load on start
await loadHotels();
renderRestaurants();
</script>
</head>
<body class="bg-gray-100 text-gray-900">
<div id="app" class="min-h-screen"></div>
</body>
</html>

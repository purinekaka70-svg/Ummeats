<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tamu Express</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

<header class="bg-green-600 text-white p-4 flex justify-between items-center">
  <h1 class="text-lg font-bold cursor-pointer">Tamu Express</h1>
  <nav>
    <button type="button" class="tab px-3 py-1 rounded" data-tab="restaurants">Restaurants</button>
    <button type="button" class="tab px-3 py-1 rounded" data-tab="orders">Orders</button>
    <button type="button" class="tab px-3 py-1 rounded" data-tab="hotel">Hotel Portal</button>
    <button type="button" class="tab px-3 py-1 rounded" data-tab="admin">Admin</button>
  </nav>
</header>

<main id="app" class="p-4 flex-1"></main>

<footer id="footer" class="bg-gray-800 text-white p-3 text-center cursor-pointer">
  @ Tamu Express | Umma-Kenya
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, setDoc, doc, onSnapshot, getDocs, updateDoc, deleteDoc 
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyApi2RjwEXEW2mTwCMiYERKUNAYL8Toddk",
  authDomain: "tamuexpress-26e4a.firebaseapp.com",
  projectId: "tamuexpress-26e4a",
  storageBucket: "tamuexpress-26e4a.appspot.com",
  messagingSenderId: "202068792631",
  appId: "1:202068792631:web:8a9b97028ebd7a45af76b2"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Variables
let hotels = [], restaurants = [], orders = [];
let cart = [], currentTab = "restaurants", currentHotelId = null, currentAdmin = null, currentCustomer = null;
const SERVICE_FEE = 40;
const SUBSCRIPTION_FEE = 100;
const ADMIN = { user: "admin", pass: "TamuAdmin@2025" };
const appDiv = document.getElementById("app");

// Hide admin tab initially
const adminTab = document.querySelector(".tab[data-tab='admin']");
adminTab.style.display = "none";

// Tab click
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>switchTab(btn.dataset.tab));
});

// Show admin on footer click 4 times
let footerClicks = 0;
document.getElementById("footer").addEventListener("click",()=>{
  footerClicks++;
  if(footerClicks>=4){
    adminTab.style.display = "inline-block";
    switchTab("admin");
    footerClicks = 0;
  }
});

function switchTab(tab){
  currentTab = tab;
  document.querySelectorAll(".tab").forEach(b=>{
    if(b.dataset.tab === tab){
      b.classList.add("bg-white","text-green-700","font-semibold");
      b.classList.remove("text-white");
    } else {
      b.classList.remove("bg-white","text-green-700","font-semibold");
      b.classList.add("text-white");
    }
  });
  render();
}

function getHotelById(id){
  return hotels.find(h=>h.id===id) || {name:"Unknown", till:"0115613332", subscriptionExpiry:0, blocked:false, approved:true};
}

// ===== Render functions =====
function render(){
  if(currentTab === "restaurants") renderRestaurants();
  else if(currentTab === "orders") renderOrders();
  else if(currentTab === "hotel") renderHotelPortal();
  else if(currentTab === "admin") renderAdmin();
}

// --- Restaurants --- (Customer view)
function renderRestaurants(){
  appDiv.innerHTML = `<h2 class="text-xl font-semibold mb-3">All Restaurants</h2>
  ${restaurants.filter(r => r.approved).map(r=>`
    <div class="bg-white p-4 rounded shadow mb-3">
      <h3 class="font-bold">${r.hotelName}</h3>
      <p class="text-sm text-gray-500">Till: ${r.till || "0115613332"}</p>
      <div class="mt-2">
        ${r.menu?.length ? r.menu.map(item=>`
          <div class="flex justify-between border-b py-2">
            <span>${item.name} - KSh ${item.price}</span>
            <button type="button" data-hotel="${r.hotelId}" data-name="${item.name}" data-price="${item.price}" class="addToCart bg-green-500 text-white px-2 py-1 rounded text-sm">Add</button>
          </div>`).join("") : `<p>No items yet</p>`}
      </div>
    </div>`).join("")}

  <div class="bg-white p-4 rounded shadow mt-6">
    <h3 class="font-semibold">Cart</h3>
    ${cart.length===0 ? "<p>Empty cart</p>" : `
      <ul class="mb-2">${cart.map((c,i)=>`<li>${c.name} - KSh ${c.price} <button type="button" data-i="${i}" class="remove text-red-500">x</button></li>`).join("")}</ul>
      <p>Items Total: KSh ${cart.reduce((s,i)=>s+i.price,0)}</p>
      <p>Service Fee: KSh ${SERVICE_FEE}</p>
      <p>Total to Pay: <strong>KSh ${cart.reduce((s,i)=>s+i.price,0)+SERVICE_FEE}</strong></p>

      ${(() => {
        if (cart.length > 0) {
          const firstHotel = getHotelById(cart[0].hotelId);
          return `
            <div class="mt-3 text-sm text-gray-700 border-t pt-2">
              <p><strong>Food Payment Till:</strong> ${firstHotel.till || "0115613332"} (${firstHotel.name})</p>
              <p><strong>Service Fee:</strong> Pay KSh ${SERVICE_FEE} to <strong>Pochi Labiashara 0115613332</strong></p>
            </div>`;
        }
        return "";
      })()}

      <input id="custName" class="border p-1 w-full mt-2" placeholder="Your name">
      <input id="custPhone" class="border p-1 w-full mt-2" placeholder="Your phone">
      <div class="mt-2 flex gap-2">
        <button type="button" id="placeOrder" class="bg-blue-600 text-white px-3 py-1 rounded">Place Order</button>
        <button type="button" id="resetCart" class="bg-gray-600 text-white px-3 py-1 rounded">Reset</button>
      </div>`}
  </div>`;
}

// --- Orders --- (Customer/Hotel/Admin)
function renderOrders(){
  let visibleOrders = [];

  if(currentHotelId){
    visibleOrders = orders.filter(o => o.hotelId === currentHotelId);
  } else if(currentAdmin){
    visibleOrders = orders;
  } else if(currentCustomer){
    visibleOrders = orders.filter(o => o.customerName === currentCustomer.name && o.customerPhone === currentCustomer.phone);
  } else {
    visibleOrders = [];
  }

  appDiv.innerHTML = `<h2 class="text-xl font-semibold mb-3">Orders</h2>
    ${visibleOrders.length===0 ? "<p>No orders yet</p>" : visibleOrders.map(o=>{
      const hotel = getHotelById(o.hotelId);
      const itemsTotal = o.items.reduce((s,i)=>s+i.price,0);
      const totalPay = o.total ?? (itemsTotal + SERVICE_FEE);
      const status = o.status || "Pending";
      const canMarkPaid = (currentHotelId && currentHotelId === o.hotelId) || currentAdmin;
      const markPaidBtn = (status !== "Paid" && canMarkPaid) ? `<button type="button" data-id="${o.id}" class="markPaid bg-green-600 text-white px-3 py-1 rounded mt-2">Mark as Paid</button>` : "";
      const statusBadge = status === "Paid" ? `<span class="text-green-700 font-semibold">Paid ✅</span>` : `<span class="text-yellow-600 font-semibold">Pending ⏳</span>`;
      return `
        <div class="bg-white p-4 rounded shadow mb-3">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold">${o.customerName}</h3>
            <div>${statusBadge}</div>
          </div>
          <p class="text-sm text-gray-600">Phone: ${o.customerPhone}</p>
          <p class="text-sm text-gray-600">Hotel: ${hotel.name} | Till: ${hotel.till}</p>
          <ul class="text-sm mt-2">${o.items.map(i=>`<li>${i.name} - KSh ${i.price}</li>`).join("")}</ul>
          <p class="text-sm mt-1">Items Total: KSh ${itemsTotal}</p>
          <p class="text-sm mt-1">Service Fee: KSh ${SERVICE_FEE} (Pay to Pochi Labiashara 0115613332)</p>
          <p class="font-semibold mt-1">Total to Pay: KSh ${totalPay}</p>
          ${markPaidBtn}
        </div>`;
    }).join("")}
  `;
}

// (Hotel portal, admin panel, event listeners all remain unchanged)
onSnapshot(collection(db,"hotels"),snap=>{
  hotels = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});
onSnapshot(collection(db,"restaurants"),snap=>{
  restaurants = snap.docs.map(d=>{
    const hotel = getHotelById(d.data().hotelId);
    return {id:d.id,...d.data(), hotelName: hotel.name, till: hotel.till, approved: hotel.approved};
  });
  render();
});
onSnapshot(collection(db,"orders"),snap=>{
  orders = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});

// (all JS logic below here unchanged)
</script>
</body>
  </html>
